# Rocky Linux 10 Kickstart Configuration
# Minimal install for Packer image building
# Note: Rocky 10 uses DNF5 and has updated package groups

# Installation settings
text
skipx
eula --agreed
firstboot --disabled
reboot --eject

# Locale and timezone
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network configuration
network --bootproto=dhcp --device=link --activate --onboot=yes
network --hostname=rocky10-template

# Authentication
rootpw --plaintext packer
user --name=packer --plaintext --password=packer --groups=wheel

# Firewall and SELinux
firewall --enabled --ssh
selinux --enforcing

# Bootloader configuration (UEFI)
bootloader --location=boot --append="crashkernel=auto"

# Disk partitioning (GPT/UEFI with LVM)
zerombr
clearpart --all --initlabel --disklabel=gpt
part /boot/efi --fstype=efi --size=600
part /boot --fstype=xfs --size=1024
part pv.01 --size=1 --grow

volgroup vg_root pv.01
logvol / --vgname=vg_root --fstype=xfs --size=1 --grow --name=lv_root
logvol swap --vgname=vg_root --fstype=swap --size=2048 --name=lv_swap

# Package selection
# Rocky 10 package groups may differ slightly from Rocky 9
%packages --ignoremissing --excludedocs
@^minimal-environment
@standard
openssh-server
openssh-clients
sudo
curl
tar
bzip2
-plymouth
-plymouth-core-libs
-iwl*firmware
%end

# Post-installation script
%post --log=/root/ks-post.log

# Update all packages (DNF5 in Rocky 10)
dnf -y update

# Enable SSH
systemctl enable sshd

# Configure sudo for packer user (NOPASSWD)
echo "packer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/packer
chmod 440 /etc/sudoers.d/packer

# Disable root SSH login (optional, can be re-enabled if needed)
# sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config

# Ensure cloud-init doesn't run if installed
systemctl disable cloud-init cloud-init-local cloud-config cloud-final 2>/dev/null || true

# Rocky 10 specific: Ensure we're using the correct DNF configuration
# DNF5 is the default in Rocky 10
if command -v dnf5 &> /dev/null; then
    echo "DNF5 detected - Rocky 10 confirmed"
fi

%end
