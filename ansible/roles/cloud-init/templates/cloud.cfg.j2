# {{ ansible_managed }}
# cloud-init configuration

# Disable root login
disable_root: true
ssh_pwauth: false

# Default user configuration
system_info:
  default_user:
    name: {{ cloud_init_default_user }}
    lock_passwd: true
    gecos: Cloud User
    groups: [wheel, adm, systemd-journal]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
    ssh_authorized_keys: []
  distro: rhel
  paths:
    cloud_dir: /var/lib/cloud
    templates_dir: /etc/cloud/templates
  ssh_svcname: sshd

# SSH key injection
ssh_deletekeys: true
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']

# Datasources configuration
{% if target_platform is defined and target_platform in cloud_init_datasources %}
datasource_list: {{ cloud_init_datasources[target_platform] | to_json }}
{% else %}
datasource_list: {{ cloud_init_datasources['default'] | to_json }}
{% endif %}

# Cloud-init modules
cloud_init_modules:
  - migrator
  - seed_random
  - bootcmd
  - write_files
  - growpart
  - resizefs
  - disk_setup
  - mounts
  - set_hostname
  - update_hostname
  - update_etc_hosts
  - ca_certs
  - rsyslog
  - users_groups
  - ssh

cloud_config_modules:
  - ssh_import_id
  - keyboard
  - locale
  - set_passwords
  - yum_add_repo
  - ntp
  - timezone
  - disable_ec2_metadata
  - runcmd

cloud_final_modules:
  - package_update_upgrade_install
  - write_files_deferred
  - puppet
  - chef
  - ansible
  - mcollective
  - salt_minion
  - reset_rmc
  - scripts_vendor
  - scripts_per_once
  - scripts_per_boot
  - scripts_per_instance
  - scripts_user
  - ssh_authkey_fingerprints
  - keys_to_console
  - install_hotplug
  - phone_home
  - final_message
  - power_state_change

# Growpart configuration
growpart:
  mode: auto
  devices: ['/']
  ignore_growroot_disabled: false

# Resize filesystem
resize_rootfs: true

# Package update on first boot
{% if cloud_init_package_update | bool %}
package_update: true
package_upgrade: true
{% else %}
package_update: false
package_upgrade: false
{% endif %}

# Final message
final_message: |
  cloud-init has finished
  version: $version
  timestamp: $timestamp
  datasource: $datasource
  uptime: $uptime
