# {{ ansible_managed }}
# CIS Benchmark Hardened SSH Configuration

# Protocol and Network
Protocol {{ hardening_ssh_protocol }}
Port {{ hardening_ssh_port }}
AddressFamily inet
ListenAddress {{ hardening_ssh_listen_address }}

# Host Keys
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

# Cryptographic Settings (CIS Benchmark compliant)
Ciphers {{ hardening_ssh_ciphers | join(',') }}
MACs {{ hardening_ssh_macs | join(',') }}
KexAlgorithms {{ hardening_ssh_kex_algorithms | join(',') }}
HostKeyAlgorithms {{ hardening_ssh_host_key_algorithms | join(',') }}

# Logging
SyslogFacility AUTH
LogLevel INFO

# Authentication Settings
LoginGraceTime {{ hardening_ssh_login_grace_time }}
PermitRootLogin {{ hardening_ssh_permit_root_login }}
StrictModes {{ hardening_ssh_strict_modes }}
MaxAuthTries {{ hardening_ssh_max_auth_tries }}
MaxSessions {{ hardening_ssh_max_sessions }}

# Public Key Authentication
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# Host-based Authentication (disabled for security)
HostbasedAuthentication no
IgnoreUserKnownHosts yes
IgnoreRhosts yes

# Password Authentication (disabled for security)
PasswordAuthentication {{ hardening_ssh_password_authentication }}
PermitEmptyPasswords {{ hardening_ssh_permit_empty_passwords }}

# Challenge Response Authentication
KbdInteractiveAuthentication {{ hardening_ssh_challenge_response_authentication }}

# Kerberos Options
KerberosAuthentication {{ hardening_ssh_kerberos_authentication }}

# GSSAPI Options
GSSAPIAuthentication {{ hardening_ssh_gssapi_authentication }}

# User and Group Restrictions
{% if hardening_ssh_allow_groups | length > 0 %}
AllowGroups {{ hardening_ssh_allow_groups | join(' ') }}
{% endif %}
{% if hardening_ssh_allow_users | length > 0 %}
AllowUsers {{ hardening_ssh_allow_users | join(' ') }}
{% endif %}
{% if hardening_ssh_deny_users | length > 0 %}
DenyUsers {{ hardening_ssh_deny_users | join(' ') }}
{% endif %}
{% if hardening_ssh_deny_groups | length > 0 %}
DenyGroups {{ hardening_ssh_deny_groups | join(' ') }}
{% endif %}

# Connection Throttling
MaxStartups {{ hardening_ssh_max_startups }}

# Session Settings
ClientAliveInterval {{ hardening_ssh_client_alive_interval }}
ClientAliveCountMax {{ hardening_ssh_client_alive_count_max }}

# Forwarding and Tunneling
AllowAgentForwarding {{ hardening_ssh_allow_agent_forwarding }}
AllowTcpForwarding {{ hardening_ssh_allow_tcp_forwarding }}
X11Forwarding {{ hardening_ssh_x11_forwarding }}
{% if hardening_ssh_x11_forwarding == 'yes' %}
X11DisplayOffset 10
X11UseLocalhost yes
{% endif %}
PermitTunnel no

# Environment
PermitUserEnvironment {{ hardening_ssh_permit_user_environment }}

# Compression
Compression {{ hardening_ssh_compression }}

# Banner
{% if hardening_banner_enabled %}
Banner /etc/issue.net
{% endif %}

# Subsystems
Subsystem sftp /usr/libexec/openssh/sftp-server

# PAM Configuration
UsePAM {{ hardening_ssh_use_pam }}

# Print Settings
PrintMotd {{ hardening_ssh_print_motd }}
PrintLastLog {{ hardening_ssh_print_last_log }}

# TCP Keepalive
TCPKeepAlive {{ hardening_ssh_tcp_keep_alive }}

# Use DNS
UseDNS no
